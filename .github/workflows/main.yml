name: CI

on:
  push:
    branches:
    - master
    - 'releases/*'
    - 'marc/gh-actions'
  pull_request: 
    branches:
    - master
    - 'releases/*'

jobs:
  linux:
    name: Linux
    runs-on: ubuntu-latest
    container: junitteam/build:latest
    steps:
    - uses: actions/checkout@master
      with:
        fetch-depth: 10
    - name: Test
      run: |
        ./gradlew --version
        ./gradlew --scan --warning-mode=all -Dplatform.tooling.support.tests.enabled=true build

  windows:
    name: Windows
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@master
      with:
        fetch-depth: 10
    - run: choco install openjdk --version 12.0.2
      shell: bash
    - name: Test
      run: |
        export JAVA_HOME="C:\Program Files\OpenJDK\jdk-12.0.2"
        export PATH="$JAVA_HOME/bin:$PATH"
        ./gradlew --version
        ./gradlew --scan --warning-mode=all -Dplatform.tooling.support.tests.enabled=true build
      shell: bash
      env:
       LC_ALL: en_US.UTF-8

  mac:
    name: Mac OS
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@master
      with:
        fetch-depth: 10
    - name: Test
      run: |
        export JAVA_HOME="${JAVA_HOME_12_X64}"
        export PATH="$JAVA_HOME/bin:$PATH"
        ./gradlew --version
        ./gradlew --scan --warning-mode=all -Dplatform.tooling.support.tests.enabled=true build
      shell: bash
      env:
       LC_ALL: en_US.UTF-8

  coverage:
    name: Coverage
    needs: linux
    runs-on: ubuntu-latest
    container: junitteam/build:latest
    steps:
    - uses: actions/checkout@master
      with:
        fetch-depth: 10
    - name: Run tests with JaCoCo
      shell: bash
      run: |
        set -e
        export JAVA_HOME="${JAVA_HOME_12_X64}"
        export PATH="${JAVA_HOME}/bin:${PATH}"
        ./gradlew --scan --stacktrace --warning-mode=all -PenableJaCoCo build jacocoRootReport
    - name: Upload to Codecov.io
      shell: bash
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      run: |
        bash <(curl -s https://codecov.io/bash)

  publish_artifacts:
    name: Publish Snapshot Artifacts
    needs: linux
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
      with:
        fetch-depth: 10
    - name: Publish
      if: github.event_name == 'push'
      env:
        ORG_GRADLE_PROJECT_sonatypeUsername: ${{ secrets.SONATYPE_USERNAME }}
        ORG_GRADLE_PROJECT_sonatypePassword: ${{ secrets.SONATYPE_PASSWORD }}
      run: |
        set -e
        export JAVA_HOME="${JAVA_HOME_12_X64}"
        export PATH="${JAVA_HOME}/bin:${PATH}"
        ./gradlew --scan publish -x check

  update_documentation:
    name: Update Snapshot Documentation
    needs: linux
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
      with:
        fetch-depth: 10
    - name: Upload Documentation
      if: github.event_name == 'push'
      env:
        GRGIT_USER: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        export JAVA_HOME="${JAVA_HOME_12_X64}"
        export PATH="${JAVA_HOME}/bin:${PATH}"
        sudo apt-get install graphviz
        ./src/publishDocumentationSnapshotOnlyIfNecessary.sh
